@*
    For more information on enabling MVC for empty projects, visit https://go.microsoft.com/fwlink/?LinkID=397860
*@
@{
}
@model ContractMonthlyClaimSystem.Models.Claim
@{
    ViewData["Title"] = "Submit New Claim";
}

<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Submit New Claim</h1>
</div>

<div class="row">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">Claim Information</h5>
            </div>
            <div class="card-body">
                <form id="claimForm" asp-action="Create" method="post" enctype="multipart/form-data">
                    <div class="mb-3">
                        <label asp-for="ClaimMonth" class="form-label">Claim Month *</label>
                        <input asp-for="ClaimMonth" type="month" class="form-control" required>
                        <span asp-validation-for="ClaimMonth" class="text-danger"></span>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="HoursWorked" class="form-label">Hours Worked *</label>
                                <input asp-for="HoursWorked" type="number" class="form-control" min="1" max="744" step="0.5" required>
                                <span asp-validation-for="HoursWorked" class="text-danger"></span>
                                <div class="form-text">Enter total hours worked this month</div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label asp-for="HourlyRate" class="form-label">Hourly Rate (R) *</label>
                                <input asp-for="HourlyRate" type="number" class="form-control" min="0" step="0.01" required>
                                <span asp-validation-for="HourlyRate" class="text-danger"></span>
                                <div class="form-text">Your contracted hourly rate</div>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Total Amount (R)</label>
                        <input type="text" class="form-control" id="totalAmount" readonly style="font-weight: bold; font-size: 1.1em;">
                    </div>

                    <div class="mb-3">
                        <label asp-for="Description" class="form-label">Description/Notes</label>
                        <textarea asp-for="Description" class="form-control" rows="3" placeholder="Describe the work completed, courses taught, or any additional information..."></textarea>
                        <span asp-validation-for="Description" class="text-danger"></span>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Supporting Documents</label>
                        <input type="file" class="form-control" name="supportingDocuments" multiple>
                        <div class="form-text">You can upload any file type. There are no restrictions on file size or format.</div>
                    </div>

                    <div id="fileList" class="mb-3"></div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="button" class="btn btn-secondary me-md-2" onclick="saveAsDraft()">Save as Draft</button>
                        <button type="submit" class="btn btn-primary">Submit Claim</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title">Claim Summary</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    Your claim will be reviewed by the Programme Coordinator and Academic Manager.
                </div>
                <div id="claimSummary">
                    <p><strong>Hours:</strong> <span id="summaryHours">0</span></p>
                    <p><strong>Rate:</strong> R<span id="summaryRate">0.00</span></p>
                    <p><strong>Total:</strong> R<span id="summaryTotal">0.00</span></p>
                </div>
            </div>
        </div>

        <div class="card mt-4">
            <div class="card-header">
                <h5 class="card-title">Quick Guide</h5>
            </div>
            <div class="card-body">
                <ul class="list-unstyled">
                    <li><i class="fas fa-check text-success me-2"></i> No file restrictions</li>
                    <li><i class="fas fa-check text-success me-2"></i> Upload multiple files</li>
                    <li><i class="fas fa-check text-success me-2"></i> Real-time calculation</li>
                    <li><i class="fas fa-check text-success me-2"></i> Save as draft option</li>
                </ul>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const hoursInput = document.getElementById('HoursWorked');
            const rateInput = document.getElementById('HourlyRate');
            const totalInput = document.getElementById('totalAmount');
            const fileInput = document.querySelector('input[name="supportingDocuments"]');
            const fileList = document.getElementById('fileList');

            // Calculate total amount when hours or rate changes
            function calculateTotal() {
                const hours = parseFloat(hoursInput.value) || 0;
                const rate = parseFloat(rateInput.value) || 0;
                const total = hours * rate;

                totalInput.value = 'R ' + total.toLocaleString('en-ZA', {minimumFractionDigits: 2, maximumFractionDigits: 2});

                // Update summary
                document.getElementById('summaryHours').textContent = hours;
                document.getElementById('summaryRate').textContent = rate.toLocaleString('en-ZA', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                document.getElementById('summaryTotal').textContent = total.toLocaleString('en-ZA', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            }

            hoursInput.addEventListener('input', calculateTotal);
            rateInput.addEventListener('input', calculateTotal);

            // Handle file selection - NO RESTRICTIONS
            fileInput.addEventListener('change', function() {
                fileList.innerHTML = '';

                if (this.files.length > 0) {
                    const list = document.createElement('ul');
                    list.className = 'list-group';

                    for (let i = 0; i < this.files.length; i++) {
                        const file = this.files[i];
                        const fileSize = (file.size / (1024 * 1024)).toFixed(2); // Size in MB

                        const listItem = document.createElement('li');
                        listItem.className = 'list-group-item d-flex justify-content-between align-items-center';
                        listItem.innerHTML = `
                            <div>
                                <i class="fas fa-file me-2"></i>
                                ${file.name}
                                <small class="text-muted ms-2">(${fileSize} MB)</small>
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeFile(${i})">
                                <i class="fas fa-times"></i>
                            </button>
                        `;
                        list.appendChild(listItem);
                    }

                    fileList.appendChild(list);
                }
            });

            // Set default month to current month
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            document.getElementById('ClaimMonth').value = `${year}-${month}`;

            // Initial calculation
            calculateTotal();
        });

        function removeFile(index) {
            // Create a new DataTransfer object to manage files
            const dataTransfer = new DataTransfer();
            const fileInput = document.querySelector('input[name="supportingDocuments"]');

            // Add all files except the one to remove
            for (let i = 0; i < fileInput.files.length; i++) {
                if (i !== index) {
                    dataTransfer.items.add(fileInput.files[i]);
                }
            }

            // Update file input files
            fileInput.files = dataTransfer.files;

            // Trigger change event to update UI
            const event = new Event('change');
            fileInput.dispatchEvent(event);
        }

        function saveAsDraft() {
            // Create a form and submit it to SaveDraft action
            const form = document.getElementById('claimForm');
            const draftForm = document.createElement('form');
            draftForm.method = 'POST';
            draftForm.action = '@Url.Action("SaveDraft", "Claims")';

            // Copy all form data
            const formData = new FormData(form);
            for (let [key, value] of formData.entries()) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = key;
                input.value = value;
                draftForm.appendChild(input);
            }

            // Add files
            const fileInput = document.querySelector('input[name="supportingDocuments"]');
            for (let i = 0; i < fileInput.files.length; i++) {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'supportingDocuments';
                input.value = fileInput.files[i].name; // This is simplified - in real app, you'd need to handle files properly
                draftForm.appendChild(input);
            }

            document.body.appendChild(draftForm);
            draftForm.submit();
        }
    </script>
}